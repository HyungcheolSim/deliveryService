<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- 부트스트랩-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="/css/review_write.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
            crossorigin="anonymous"></script>
    <!-- Jquery-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="/js/common.js"></script>

    <title>리뷰 수정 페이지</title>
    <script>
        //현재 주소에서 id만 추출
        let orderId = [[${order_id}]];

        //let review_id = document.location.href.split("/review/").at(1);
        let reviewId = [[${review_id}]];

        $(document).ready(function () {
            showButtons();
            console.log("Order Id :" + orderId);
            console.log("Review Id :" + reviewId);

            let id = 1;
            console.log("shop Id: " + id);
            //getOrder(id);
            getShop(id);
            getOneReviewContents(reviewId);
        })

        //order 정보 가져와서 띄워주고, contents 입력받아서 추가, orderId
        // 여기서 {order_id}를 넣어주는 형태가 이게 맞는지
        function getOrder(id) {
            $.ajax({
                type: 'GET',
                url: `/api/orders/${id}`,
                contentType: 'application/json',
                success: function (response) {
                    let paymentMethod = response['paymentMethod'];
                    let request = response['request'];
                    let member = response['member'];
                    let shop = response['shop'];
                    let shopName = shop['shopName'];
                    let orderMenuList = response['orderMenuList'];
                    for (let i = 0; i < orderMenuList.length; i++) {
                        let menuName = orderMenuList['menuName'];
                        let amount = orderMenuList['amount'];
                        let price = orderMenuList['price'];
                        addHTML(menuName, amount, price);
                    }
                    let createdAt = response['createdAt'];
                    console.log(response)
                }
            })
        }

        function getShop(id) {
            $.ajax({
                type: 'GET',
                url: `/api/shops/${id}`,
                contentType: 'application/json',
                success: function (response) {
                    console.log(response)
                    let shopName = response['data']['shopname'];
                    let review_count = response['data']['review_count'];
                    let address = response['data']['address'];
                    let phone = response['data']['phone_number'];
                    let username = response['data']['username'];
                    let image_url = response['data']['image_url'];
                    addHTML(shopName, review_count, address, phone, username, image_url);
                }
            })
        }

        function getOneReviewContents(reviewId) {
            $.ajax({
                type: 'GET',
                url: `/api/reviews/${reviewId}`,
                contentType: 'application/json',
                success: function (response) {
                    console.log(response)
                    let ex_content = response['data']['contents'];
                    addHTMLContents(ex_content);
                }
            })
        }

        function addHTML(shopName, review_count, address, phone, username, image_url) {
            //TODO Order 완성 후 order 에 맞게 수정 필요 현재 기능 동작 확인 완료
            //image url 이 null 이면 default 이미지 스프링 르탄이가 나타나도록 함
            $('.order-info-container').empty();
            let imagehtml
            if (image_url == null) {
                imagehtml = `<div class="profile-image">
            <img src="/images/spring_letan.png" class="image"/>`
            } else {
                imagehtml = `<div class="profile-image">
            <img src="${image_url}" class="image"/>`
            }
            let tempHtml = `<div class="order-date">
                <h5 id="count">${review_count}</h5>
            </div>
        </div>

        <div class="order-info">
            <div class="order-menu-info">
                <h1 id="shopName">${shopName}</h1>
                <h5>치킨치즈볼 5개 22,900</h5>
            </div>
        </div>

        <div class="payment-request-container">
            <div class="payment-container">
                <h3>결제 방법</h3>
                <p>${address}</p>
                <p></p>
            </div>
            <div class="request-container">
                <h3>요청 사항</h3>
                <p>${phone}</p>
                <p>${username}</p>
            </div>
        </div>`
            $('.order-info-container').append(imagehtml).append(tempHtml);
        }

        function addHTMLContents(ex_contents) {
            $('.review-content-container').empty();
            let contentHtml = `<textarea id="review-content" rows="10">${ex_contents}</textarea>`;
            $('.review-content-container').append(contentHtml);
        }

        function updateReivew() {
            let contents = $('#review-content').val();
            if (isValidContents(contents) == false) {
                return;
            }
            let data = {
                'reviewId': reviewId, 'contents': contents
            };
            $.ajax({
                type: "PUT",
                url: "/api/reviews",
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function (response) {
                    alert(response['message']);
                    //TODO 멤버 찜목록 페이지로 이동 // 일단은 홈페이지로 이동하도록 함.
                    window.location.href = "/";
                }
            })
        }
    </script>
</head>
<body>
<div class="containers">
    <div class="order-info-container">
        <div class="profile-image">
            <img src="/images/spring_letan.png" class="image"/> <!--가게 디폴트 이미지 -->
            <div class="order-date">
                <h5>2022. 6. 1 (수)</h5>
            </div>
        </div>

        <div class="order-info">
            <div class="order-menu-info">
                <h1>60계 치킨 안양호계점</h1>
                <h5>장스 치킨 1개 22,900</h5>
                <h5>치킨치즈볼 5개 22,900</h5>
            </div>
        </div>

        <div class="payment-request-container">
            <div class="payment-container">
                <h3>결제 방법</h3>
                <p>현장 카드 결제</p>
            </div>
            <div class="request-container">
                <h3>요청 사항</h3>
                <p>벨 누르지 말아주세요 현관 비밀번호 123123</p>
            </div>
        </div>
    </div>
    <h1 style="margin-left:10%">리뷰 수정</h1>
    <div class="review-content-container">
        <textarea id="review-content" rows="10">${ex_contents}</textarea>
    </div>
    <div class="review-btn-container">
        <button type="button" class="btn btn-success" onclick="updateReivew()">수정 완료</button>
        <button type="button" class="btn btn-success" onclick="history.back()">취소</button>
    </div>
</div>
<div class="footer">
    <div th:replace="~{/fragments/footer.html::fragment-footer-default}"></div>
</div>

</body>
</html>