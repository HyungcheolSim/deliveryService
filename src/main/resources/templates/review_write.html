<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- 부트스트랩-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="/css/review_write.css">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
            crossorigin="anonymous"></script>
    <!-- Jquery-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <title>리뷰 작성 페이지</title>
    <script>
        //현재 주소에서 id만 추출
        let id = document.location.href.split("/orders/").at(1).replace("/review", "");

        $(document).ready(function () {
            const auth = getToken();
            const host= 'http://'+window.location.host;

            //토큰 유효성 확인
            if (auth !== undefined && auth !== '') {
                $.ajaxPrefilter(function (options, originalOptions, jqXHR) {
                    jqXHR.setRequestHeader('Authorization', auth);
                });
            } else {
                //로그인 url 확인
                window.location.href = host + '/api/user/login-page';
                return;
            }


            console.log(id);
            //getOrder(id);
            getShop(id);
        })

        function logout() {
            // 토큰 삭제
            Cookies.remove('Authorization', {path: '/'});
            window.location.href = host + '/api/user/login-page';
        }

        function getToken() {

            let auth = Cookies.get('Authorization');

            if (auth === undefined) {
                return '';
            }

            // kakao 로그인 사용한 경우 Bearer 추가
            if (auth.indexOf('Bearer') === -1 && auth !== '') {
                auth = 'Bearer ' + auth;
            }

            return auth;
        }

        //order 정보 가져와서 띄워주고, contents 입력받아서 추가, orderId
        // 여기서 {order_id}를 넣어주는 형태가 이게 맞는지
        function getOrder(id) {
            $.ajax({
                type: 'GET',
                url: `/api/orders/${id}`,
                contentType: 'application/json',
                success: function (response) {
                    let paymentMethod = response['paymentMethod'];
                    let request = response['request'];
                    let member = response['member'];
                    let shop = response['shop'];
                    let shopName = shop['shopName'];
                    let orderMenuList = response['orderMenuList'];
                    for (let i = 0; i < orderMenuList.length; i++) {
                        let menuName = orderMenuList['menuName'];
                        let amount = orderMenuList['amount'];
                        let price = orderMenuList['price'];
                        addHTML(menuName, amount, price);
                    }
                    let createdAt = response['createdAt'];
                    console.log(response)
                }
            })
        }

        function getShop(id) {
            $.ajax({
                type: 'GET',
                url: `/api/shops/${id}`,
                contentType: 'application/json',
                success: function (response) {
                    console.log(response)
                    let shopName = response['data']['shopname'];
                    let review_count = response['data']['review_count'];
                    let address = response['data']['address'];
                    let phone = response['data']['phone_number'];
                    let username = response['data']['username'];
                    addHTML2(shopName, review_count, address, phone, username);
                }
            })
        }

        function addHTML2(shopName, review_count, address, phone, username) {
            //TODO Order 완성 후 order 에 맞게 수정 필요 현재 기능 동작 확인 완료, shop 이미지 경로 추가되면 추가해줘야함!

            $('.order-info-container').empty();
            let tempHtml = `<div class="profile-image">
            <img src="/images/spring_letan.png" class="image"/> <!--가게 디폴트 이미지 -->
            <div class="order-date">
                <h5 id="count">${review_count}</h5>
            </div>
        </div>

        <div class="order-info">
            <div class="order-menu-info">
                <h1 id="shopName">${shopName}</h1>
                <h5>치킨치즈볼 5개 22,900</h5>
            </div>
        </div>

        <div class="payment-request-container">
            <div class="payment-container">
                <h3>결제 방법</h3>
                <p>${address}</p>
                <p></p>
            </div>
            <div class="request-container">
                <h3>요청 사항</h3>
                <p>${phone}</p>
                <p>${username}</p>
            </div>
        </div>`
            $('.order-info-container').append(tempHtml);
        }

        function writeReivew() {
            let contents = $('#review-content').val();
            if (isValidContents(contents) == false) {
                return;
            }
            let data = {
                'orderId': id, 'contents':contents;
            }
            $.ajax({
                type: "POST",
                url: "/api/reviews",
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function (response){
                    alert(response['message']);
                    //TODO 멤버 찜목록 페이지로 이동 // 일단은 홈페이지로 이동하도록 함.
                    window.location.href="/";
                }
            }
        })

            function isValidContents(contents) {
                if (contents == '') {
                    alert('내용을 입력해주세요');
                    return false;
                }
                if (contents.trim().length <= 10) {
                    alert('10자 이상 입력해주세요.');
                    return false;
                }
                return true;
            }
    </script>
</head>
<body>
<div class="containers">
    <div class="order-info-container">
        <div class="profile-image">

            <img src="/images/spring_letan.png" class="image"/> <!--가게 디폴트 이미지 -->
            <div class="order-date">
                <!--  <h5>${createdAt}</h5> -->
                <h5 id="count">${review_count}</h5>
            </div>
        </div>

        <div class="order-info">
            <div class="order-menu-info">
                <h1 id="shopName">${shopName}</h1>
                <h5>치킨치즈볼 5개 22,900</h5>
            </div>
        </div>

        <div class="payment-request-container">
            <div class="payment-container">
                <h3>결제 방법</h3>
                <p>${paymentMethod}</p>
                <p>[[${address}]]</p>
                <p></p>
            </div>
            <div class="request-container">
                <h3>요청 사항</h3>
                <p>${request}</p>
                <p>${phone}</p>
                <p>${username}</p>
            </div>
        </div>
    </div>
    <h1 style="margin-left:10%">리뷰 작성</h1>
    <div class="review-content-container">
        <textarea id="review-content" rows="10"></textarea>
    </div>
    <div class="review-btn-container">
        <button type="button" class="btn btn-success">작성 완료</button>
        <button type="button" class="btn btn-success">취소</button>
    </div>
</div>
<div class="footer">
    <div th:replace="~{/fragments/footer.html::fragment-footer-default}"></div>
</div>
<!-- 로그인 이후에는 fragment-footer-login 으로 변경되어야 함-->
</body>
</html>